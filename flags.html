<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Βρες τους γείτονες</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="countries.js"></script>
    <script>
        const allCountries = new Array();   // unused
        const previousPlayedCountries = new Array();
        const urlCountry = 'https://restcountries.eu/rest/v2/name/';
        const urlCode = 'https://restcountries.eu/rest/v2/alpha/';

        var globalCountry = "";
        var globalNeighbors = "";
        var globalFoundCountries = 0;
        var globalWrongCountries = 0;
        var globalClickedCountries = [];
        class PlayingCountry{
            constructor(country, neighbours){
                this.country = country;
                this.neighbours = neighbours;
            }  
        }

        class Game{

            constructor(){
                this.score = 0;
                this.round = 0;
            }

            nextRound(selectedCountry){
                fetch(urlCode+selectedCountry.code3.toLowerCase())
                .then((response) => {
                    if (response.status === 200) {
                        return response.json();
                    } else {
                        throw new Error(response.status);
                    }
                    
                })
                .then((data) => {
                    document.getElementById("countries_list").innerHTML = ''; // clear the div from previous countries
                    document.getElementById("header_image").src = 'https://restcountries.eu/data/' + selectedCountry.code3.toLowerCase() + '.svg';
                    document.getElementById("header_country").innerHTML = selectedCountry.name;
                    if (data.length < 1) {
                        throw new Error("Η χώρα δεν βρέθηκε!");
                    } else {
                        if (data.borders.length > 0) {
                            let country = data.borders;
                            let realNeighbors = new Array();
                            for(let i=0; i<data.borders.length; i++){
                                realNeighbors.push(countryObjects.find((s) => s['code3']===data.borders[i]))
                            }
                            let playingCountry = new PlayingCountry(selectedCountry.name, realNeighbors);
                            globalNeighbors = realNeighbors;    // reset the real neighbors of the country
                            globalFoundCountries = 0;           // reset the real neighbors found by the user
                            globalWrongCountries = 0;           // reset the wrong choices the user made
                            return playingCountry;
                        }
                        else {
                            let selectedCountry = this.chooseCountry();
                            console.log("Χώρα: ", selectedCountry.name)
                            game.nextRound(selectedCountry);
                        }
                    }
                }).then(playingCountry=>{
                    let possibleNeighbors = this.createDisplayedCountries(playingCountry);
                    globalCountry = selectedCountry;
                    console.log("Γείτονες που θα εμφανιστούν στο παίκτη: ", possibleNeighbors);
                    var i = 0;
                    for (i = 0; i < possibleNeighbors.length; i++) {
                        var countryCode = possibleNeighbors[i].code3.toLowerCase();
                        var countryName = possibleNeighbors[i].name;
                        var countryDiv = document.createElement('div');
                        var countryDivHref = document.createElement('a');
                        var countryDivImage = document.createElement('img');
                        var countryDivName = document.createElement('p');
                        var element = document.getElementById("countries_list");
                        countryDiv.setAttribute("id", "id_" + countryCode);
                        countryDiv.setAttribute("class", "flex-country");
                        countryDiv.setAttribute("style", "word-wrap: break-word;");
                        countryDiv.setAttribute("onclick","getClickedCountry(this.id)")
                        countryDivHref.setAttribute('href', "#");
                        countryDivHref.setAttribute('onclick', "changeProgressBar(10)");
                        countryDivImage.src = 'https://restcountries.eu/data/' + countryCode + '.svg';
                        countryDivName.innerHTML = countryName;
                        countryDivName.setAttribute("style","text-align: center;");
                        countryDivHref.appendChild(countryDivImage);
                        countryDiv.appendChild(countryDivHref);
                        countryDiv.appendChild(countryDivImage);
                        countryDiv.appendChild(countryDivName);
                        element.appendChild(countryDiv);
                    }
                    console.log("Πραγματικοί Γείτονες: ");
                    for (var i=0; i<globalNeighbors.length; i++) {
                        console.log(globalNeighbors[i]);
                    }
                    var surroundingBox = document.getElementsByClassName("game-panel");
                    if (surroundingBox[0].clientWidth > 800) 
                        document.getElementById("sidenav").style.height = (surroundingBox[0].clientHeight-25) + "px";
                    game.round = game.round + 1;
                    changePlayerRound(game.round);
                });
            }

            createDisplayedCountries(playingCountry){
                let list= new Array();
                for (let i=0; i<playingCountry.neighbours.length; i++){
                    list.push( countryObjects.find((s) => s['code3']===playingCountry.neighbours[i].code3))
                }
                let numberOfNeededCountries = playingCountry.neighbours.length * 3;
                while ( list.length < numberOfNeededCountries)
                {
                    this.chooseRoundCountries(list);
                }
                let displayCountriesList = shuffleArray(list);
                return displayCountriesList;
            }

            chooseCountry(){               
                let arrayWithSuffledCountries = shuffleArray(countryObjects);
                while ( previousPlayedCountries.find((s) => s['code']===arrayWithSuffledCountries[0]['code']) != undefined){
                    arrayWithSuffledCountries = shuffleArray(countryObjects);
                }
                previousPlayedCountries.push(arrayWithSuffledCountries[0]);
                let selectedCountry = arrayWithSuffledCountries[0]
                return selectedCountry
            }

            chooseRoundCountries(previousPlayedCountries){
                let arrayWithSuffledCountries = shuffleArray(countryObjects);
                while ( previousPlayedCountries.find((s) => s['code']===arrayWithSuffledCountries[0]['code']) != undefined){
                    arrayWithSuffledCountries = shuffleArray(countryObjects);
                }
                previousPlayedCountries.push(arrayWithSuffledCountries[0]);
                let selectedCountry = arrayWithSuffledCountries[0]
            }

        }

        function changeProgressBar(step) {
            var elem = document.getElementById("progress-bar");
            elem.style.width = step + "%";   
        }

        function changePlayerRound(round) {
            document.getElementById("player_round").innerHTML = round;
        }

        function changePlayerScore(score) {
            document.getElementById("player_score").innerHTML = score;
        }

        function resetOverlay() {
            document.getElementById("overlayBox").style.backgroundColor = "#fff"; 
            document.getElementById("overlayBox").style.opacity = 1.0;
            document.getElementById("overlayBox").style.pointerEvents = "auto"; // enable functionality on the overlay
            document.getElementById("overlayText").style.display = "none";
            document.getElementById("overlayText").innerHTML = "";
        }

        function displayOverlay(text,color) {
            var elmnt = document.getElementById("countries_list");
            let centerX = elmnt.offsetLeft + elmnt.offsetWidth/2;
            let centerY = elmnt.offsetTop + elmnt.offsetHeight/2;
            document.getElementById("overlayBox").style.backgroundColor = "rgb(0,0,0,0.4)"; 
            document.getElementById("overlayBox").style.opacity = 0.3;
            document.getElementById("overlayBox").style.pointerEvents = "none"; // disable functionality on the overlay
            document.getElementById("overlayText").style.left = centerX-100 + "px";
            document.getElementById("overlayText").style.top = centerY-50 + "px";
            document.getElementById("overlayText").style.display = "block";
            document.getElementById("overlayText").innerHTML = text;
            document.getElementById("overlayText").style.color = color;
            for (var i = 0; i < globalClickedCountries.length; i++) {
                document.getElementById(globalClickedCountries[i]).style.backgroundColor = "#a6a6a6"; 
            }
        }

        function getClickedCountry(div_id) {
            globalClickedCountries.push(div_id);    // gather all the clicked ids of the countries
            var clickedCountryCode = div_id.split("id_")[1].toUpperCase();
            if (globalNeighbors.find((s) => s['code3']===clickedCountryCode) != undefined){
                document.getElementById(div_id).style.border = "2px solid green";
                document.getElementById(div_id).style.backgroundColor = "#f2f2f2";
                globalFoundCountries = globalFoundCountries + 1;
                var progressBarStep = globalFoundCountries/globalNeighbors.length * 100;
                changeProgressBar(progressBarStep);
                if (progressBarStep == 100) {
                    document.getElementById("btn-next-round").disabled = false; // if all countries found, win roundenable the button for next round
                    displayOverlay("Τους βρήκατε όλους", "black");
                }
                game.score = game.score + 5;
                changePlayerScore(game.score);
            } else {
                document.getElementById(div_id).style.border = "2px solid red";
                document.getElementById(div_id).style.backgroundColor = "#f2f2f2";
                game.score = game.score - 3;
                globalWrongCountries = globalWrongCountries + 1;
                if (globalWrongCountries === globalNeighbors.length){
                    document.getElementById("btn-next-round").disabled = false; // if max number of wrong countries selected, lose round and enable the button for next round
                    displayOverlay("Κρίμα, χάσατε!", "red");
                }
                changePlayerScore(game.score);
            }
        }

        $(window).resize(function () {
            var round = "lost";
            if (round == "lost"){
                var surroundingBox = document.getElementsByClassName("game-panel");
                if (surroundingBox[0].clientWidth > 800) 
                    document.getElementById("sidenav").style.height = (surroundingBox[0].clientHeight-25) + "px";
                var countriesBox = document.getElementById("countries_list");
                let centerX = countriesBox.offsetLeft + countriesBox.offsetWidth/2;
                let centerY = countriesBox.offsetTop + countriesBox.offsetHeight/2;
                document.getElementById("overlayText").style.left = centerX-100 + "px";
                document.getElementById("overlayText").style.top = centerY-50 + "px";
            } 
        });

        document.addEventListener("DOMContentLoaded", () => {

            // Begin game when page loads for the 1st time
            game = new Game();
            let selectedCountry = game.chooseCountry();
            console.log("Χώρα: ", selectedCountry.name)
            game.nextRound(selectedCountry);
            document.querySelector("#btn-new-game").addEventListener("click", () => {
                var response = confirm("Σίγουρα; Θα χάσετε όλο σας το σκόρ!");
                if (response == true) {   
                    game = new Game();
                    let selectedCountry = game.chooseCountry();
                    console.log("Χώρα: ", selectedCountry.name)
                    game.nextRound(selectedCountry);
                    changeProgressBar(0);   // reset Progress Bar
                    changePlayerScore(0);   // reset player score
                    resetOverlay();         // remove the overlay message
                }
            });

            document.querySelector("#btn-next-round").addEventListener("click", () => {
                let selectedCountry = game.chooseCountry();
                console.log("Χώρα: ", selectedCountry.name)
                game.nextRound(selectedCountry);
                changeProgressBar(0);       // reset Progress Bar
                resetOverlay();             // remove the overlay message
            })

        });
    </script>
</head>

<body>
    <div class="game-panel">
        <div class="row-inline">
            <div id="sidenav">
                <p><strong>Βρες τους γείτονες</strong></p><br>
                <div style="overflow: hidden;">
                    <p style="float: left;">Γύρος: </p>
                    <p id="player_round" style="float: right;">0</p>
                </div>
                <div style="overflow: hidden;">
                    <p style="float: left;">Σκορ: </p>
                    <p id="player_score" style="float: right;">0</p>
                </div>
                <div class="text-center">
                    <button id="btn-next-round" class="btn btn-light btn-block" disabled>Επόμενη Χώρα</button>
                    <button id="btn-new-game" class="btn btn-light btn-block">Νέο Παιχνίδι</button>
                </div>
            </div>

            <div class="main">
                <h2>
                    <img id="header_image">
                    <p id="header_country"></p>
                </h2>
                <div class="progress">
                    <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div id="overlayBox">
                    <ul class="flex-container wrap" id="countries_list"></ul>
                    <strong><div id="overlayText"></div></strong>
                </div>
            </div>
        </div> 
    </div>
</body>

<script>
//Το παρακάτω αφορά μόνο τους χρήστες macOS.
if (navigator.appVersion.indexOf("Macintosh")>0){
  document.body.style.fontFamily = '"Open Sans"';
}
</script>

</html>